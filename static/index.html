<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Todo List — Demo Site</title>

  <!-- Reduce noisy 404s from browser auto-requests -->
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png" />

  <style>
    :root {
      --bg0: #070A12;
      --bg1: #0B1020;
      --card: rgba(255,255,255,.08);
      --card-border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.52);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow-soft: 0 10px 30px rgba(0,0,0,.35);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --gold: #D7B56D;
      --gold2: #B88A3B;
      --accent: #8B5CF6;
      --accent2: #6366F1;
      --danger: #ef4444;
      --stroke: rgba(255,255,255,.14);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(183,138,59,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 18%, rgba(139,92,246,.25), transparent 62%),
        radial-gradient(700px 520px at 60% 92%, rgba(99,102,241,.22), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    /* Subtle animated sheen / particles */
    body::before {
      content: "";
      position: fixed;
      inset: -40% -40%;
      background:
        radial-gradient(2px 2px at 15% 25%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(1.6px 1.6px at 70% 40%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(1.8px 1.8px at 30% 70%, rgba(255,255,255,.09), transparent 60%),
        radial-gradient(1.4px 1.4px at 85% 78%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(1.2px 1.2px at 45% 52%, rgba(255,255,255,.07), transparent 60%);
      filter: blur(.1px);
      opacity: .55;
      transform: translate3d(0,0,0);
      animation: drift 18s ease-in-out infinite alternate;
      pointer-events: none;
    }

    body::after {
      content: "";
      position: fixed;
      inset: -30% -30%;
      background:
        conic-gradient(from 210deg at 60% 30%, rgba(215,181,109,.08), rgba(139,92,246,.08), rgba(99,102,241,.08), rgba(215,181,109,.08));
      filter: blur(45px);
      opacity: .35;
      animation: sheen 14s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes drift {
      from { transform: translate(-1.5%, -1%) scale(1); }
      to   { transform: translate(1.5%, 1.2%) scale(1.02); }
    }

    @keyframes sheen {
      from { transform: translate(-1.2%, .8%) rotate(-3deg) scale(1); }
      to   { transform: translate(1.2%, -1%) rotate(3deg) scale(1.03); }
    }

    /* ── Header ── */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 18px 0 16px;
      text-align: center;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(8,10,18,.72), rgba(8,10,18,.38));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    header .inner {
      max-width: 860px;
      margin: 0 auto;
      padding: 0 16px;
      position: relative;
    }

    header h1 {
      font-size: 24px;
      font-weight: 750;
      letter-spacing: -.5px;
      line-height: 1.15;
    }

    header p {
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .brand-link {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: 999px;
      text-decoration: none;
      color: rgba(255,255,255,.92);
      background: linear-gradient(135deg, rgba(215,181,109,.20), rgba(184,138,59,.10));
      border: 1px solid rgba(215,181,109,.30);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }

    .brand-link:hover {
      transform: translateY(-50%) translateY(-1px);
      border-color: rgba(215,181,109,.45);
      background: linear-gradient(135deg, rgba(215,181,109,.26), rgba(184,138,59,.12));
    }

    .brand-link:active {
      transform: translateY(-50%) translateY(0px);
    }

    .brand-badge {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff, var(--gold));
      box-shadow: 0 0 0 3px rgba(215,181,109,.15);
      flex: 0 0 auto;
    }

    .brand-text {
      font-size: 12px;
      font-weight: 650;
      letter-spacing: .15px;
      white-space: nowrap;
    }

    /* ── Layout ── */
    main {
      max-width: 680px;
      margin: 26px auto;
      padding: 0 16px 120px;
      position: relative;
      z-index: 1;
    }

    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panel-top {
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(800px 220px at 20% 0%, rgba(215,181,109,.18), transparent 65%),
        radial-gradient(700px 240px at 85% 0%, rgba(139,92,246,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }

    /* ── Add form ── */
    .add-form {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .add-form input {
      flex: 1;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      outline: none;
      color: rgba(255,255,255,.92);
      background: rgba(8,10,18,.40);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      transition: border-color .15s ease, box-shadow .15s ease;
    }

    .add-form input::placeholder { color: rgba(255,255,255,.45); }

    .add-form input:focus {
      border-color: rgba(215,181,109,.55);
      box-shadow: 0 0 0 4px rgba(215,181,109,.12), inset 0 1px 0 rgba(255,255,255,.06);
    }

    .add-form button {
      background: linear-gradient(135deg, rgba(215,181,109,.95), rgba(184,138,59,.95));
      color: rgba(14, 16, 24, .96);
      border: 1px solid rgba(215,181,109,.55);
      border-radius: 12px;
      padding: 11px 18px;
      font-size: 13px;
      font-weight: 750;
      cursor: pointer;
      transition: transform .12s ease, filter .15s ease;
      white-space: nowrap;
      box-shadow: 0 12px 26px rgba(0,0,0,.30);
    }

    .add-form button:hover { filter: brightness(1.03); transform: translateY(-1px); }
    .add-form button:active { transform: translateY(0); }

    /* ── Stats / Content ── */
    .panel-body {
      padding: 14px 18px 18px;
    }

    .stats {
      font-size: 12px;
      color: var(--muted2);
      margin: 2px 2px 12px;
    }

    /* ── Todo list ── */
    .todo-list { display: flex; flex-direction: column; gap: 10px; }

    .todo-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(8,10,18,.35);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 14px 14px;
      box-shadow: var(--shadow-soft);
      transition: transform .12s ease, border-color .15s ease, opacity .2s;
      animation: slide-in .2s ease;
    }

    .todo-item:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.16);
    }

    @keyframes slide-in {
      from { opacity:0; transform:translateY(-6px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .todo-item.done { opacity: .62; }
    .todo-item.done .todo-title { text-decoration: line-through; color: rgba(255,255,255,.55); }

    .todo-check {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      accent-color: #D7B56D;
      cursor: pointer;
    }

    .todo-title { flex: 1; font-size: 15px; line-height: 1.4; }

    .todo-id {
      font-size: 11px;
      color: rgba(255,255,255,.34);
      border: 1px solid rgba(255,255,255,.10);
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
    }

    .todo-delete {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.55);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 6px 10px;
      border-radius: 10px;
      transition: color .15s ease, border-color .15s ease, background .15s ease, transform .12s ease;
    }

    .todo-delete:hover {
      color: rgba(255,255,255,.9);
      border-color: rgba(239, 68, 68, .35);
      background: rgba(239, 68, 68, .10);
      transform: translateY(-1px);
    }

    .todo-delete:active { transform: translateY(0); }

    .empty-state {
      text-align: center;
      padding: 46px 0 44px;
      color: rgba(255,255,255,.58);
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 14px;
      background: rgba(8,10,18,.25);
    }

    .empty-state .icon { font-size: 40px; margin-bottom: 10px; }
    .empty-state p { font-size: 14px; }

    .error-banner {
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.28);
      color: rgba(255,255,255,.90);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 13px;
      margin: 0 2px 12px;
      display: none;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }

    /* ── Tic Tac Toe ── */
    .tictactoe {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.10);
    }

    .ttt-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 2px 2px 12px;
    }

    .ttt-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .ttt-title h2 {
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .ttt-title p {
      font-size: 12px;
      color: rgba(255,255,255,.58);
    }

    .ttt-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 0 0 auto;
    }

    .ttt-btn {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.82);
      cursor: pointer;
      font-size: 12px;
      font-weight: 750;
      padding: 9px 12px;
      border-radius: 12px;
      transition: transform .12s ease, border-color .15s ease, background .15s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }

    .ttt-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(215,181,109,.35);
      background: rgba(215,181,109,.08);
    }

    .ttt-btn:active { transform: translateY(0); }

    .ttt-board {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      background: rgba(8,10,18,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow-soft);
    }

    .ttt-cell {
      height: 86px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(400px 120px at 30% 20%, rgba(215,181,109,.10), transparent 60%),
        radial-gradient(450px 160px at 80% 20%, rgba(139,92,246,.10), transparent 60%),
        rgba(255,255,255,.04);
      color: rgba(255,255,255,.92);
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 34px;
      font-weight: 900;
      letter-spacing: -1px;
      transition: transform .12s ease, border-color .15s ease, background .15s ease;
      user-select: none;
    }

    .ttt-cell:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.18);
    }

    .ttt-cell:active { transform: translateY(0); }

    .ttt-cell[disabled] {
      cursor: not-allowed;
      opacity: .9;
    }

    .ttt-cell.x {
      color: rgba(215,181,109,.95);
      text-shadow: 0 10px 30px rgba(215,181,109,.16);
    }

    .ttt-cell.o {
      color: rgba(139,92,246,.95);
      text-shadow: 0 10px 30px rgba(139,92,246,.16);
    }

    .ttt-cell.win {
      border-color: rgba(215,181,109,.55);
      background: rgba(215,181,109,.10);
      box-shadow: 0 16px 40px rgba(215,181,109,.10);
      animation: pop .18s ease;
    }

    @keyframes pop {
      from { transform: scale(.98); }
      to { transform: scale(1); }
    }

    .ttt-status {
      margin: 10px 4px 0;
      font-size: 12px;
      color: rgba(255,255,255,.62);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .ttt-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }

    .ttt-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.22);
    }

    .ttt-dot.x { background: rgba(215,181,109,.9); }
    .ttt-dot.o { background: rgba(139,92,246,.9); }

    /* ── Mindmap ── */
    .mindmap {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.10);
    }

    .mm-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 2px 2px 12px;
    }

    .mm-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .mm-title h2 {
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .mm-title p {
      font-size: 12px;
      color: rgba(255,255,255,.58);
    }

    .mm-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 0 0 auto;
    }

    .mm-btn {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.82);
      cursor: pointer;
      font-size: 12px;
      font-weight: 750;
      padding: 9px 12px;
      border-radius: 12px;
      transition: transform .12s ease, border-color .15s ease, background .15s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      white-space: nowrap;
    }

    .mm-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(215,181,109,.35);
      background: rgba(215,181,109,.08);
    }

    .mm-btn:active { transform: translateY(0); }

    .mm-wrap {
      background: rgba(8,10,18,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .mm-svg {
      width: 100%;
      height: 320px;
      display: block;
    }

    .mm-node {
      fill: rgba(255,255,255,.05);
      stroke: rgba(255,255,255,.14);
      stroke-width: 1;
    }

    .mm-node.root {
      stroke: rgba(215,181,109,.55);
      fill: rgba(215,181,109,.08);
    }

    .mm-link {
      stroke: rgba(255,255,255,.22);
      stroke-width: 1.5;
      fill: none;
    }

    .mm-text {
      fill: rgba(255,255,255,.90);
      font-size: 12px;
      font-weight: 650;
    }

    .mm-hint {
      margin: 10px 4px 0;
      font-size: 12px;
      color: rgba(255,255,255,.62);
      display: none;
    }

    /* Responsive: keep brand link visible but not overlapping */
    @media (max-width: 540px) {
      header .inner { padding-top: 40px; }
      .brand-link {
        top: 12px;
        transform: none;
      }
      .brand-link:hover { transform: translateY(-1px); }

      .ttt-cell { height: 72px; font-size: 30px; }
      .mm-svg { height: 360px; }
    }
  </style>
</head>
<body>

<header>
  <div class="inner">
    <a class="brand-link" href="https://balanco.fi" target="_blank" rel="noopener noreferrer" title="Visit Balanco Accounting">
      <span class="brand-badge" aria-hidden="true"></span>
      <span class="brand-text">Balanco Accounting</span>
    </a>

    <h1>Todo List</h1>
    <p>Demo Site — powered by Balanco Agent</p>
  </div>
</header>

<main>
  <section class="panel" aria-label="Todo app">
    <div class="panel-top">
      <div class="add-form">
        <input id="new-todo" type="text" placeholder="What needs to be done?" />
        <button onclick="addTodo()">Add</button>
      </div>
    </div>

    <div class="panel-body">
      <div class="error-banner" id="error-banner"></div>
      <div class="stats" id="stats"></div>
      <div class="todo-list" id="todo-list"></div>

      <div class="tictactoe" aria-label="Tic tac toe">
        <div class="ttt-header">
          <div class="ttt-title">
            <h2>Tic Tac Toe</h2>
            <p>Play locally — X starts. First to 3 in a row wins.</p>
          </div>
          <div class="ttt-actions">
            <button class="ttt-btn" onclick="tttNewGame()" title="Start a new game">New game</button>
            <button class="ttt-btn" onclick="tttResetScore()" title="Reset scoreboard">Reset score</button>
          </div>
        </div>

        <div class="ttt-board" id="ttt-board" role="grid" aria-label="Tic tac toe board">
          <button class="ttt-cell" data-idx="0" aria-label="Cell 1"></button>
          <button class="ttt-cell" data-idx="1" aria-label="Cell 2"></button>
          <button class="ttt-cell" data-idx="2" aria-label="Cell 3"></button>
          <button class="ttt-cell" data-idx="3" aria-label="Cell 4"></button>
          <button class="ttt-cell" data-idx="4" aria-label="Cell 5"></button>
          <button class="ttt-cell" data-idx="5" aria-label="Cell 6"></button>
          <button class="ttt-cell" data-idx="6" aria-label="Cell 7"></button>
          <button class="ttt-cell" data-idx="7" aria-label="Cell 8"></button>
          <button class="ttt-cell" data-idx="8" aria-label="Cell 9"></button>
        </div>

        <div class="ttt-status" aria-live="polite">
          <span class="ttt-pill" id="ttt-turn-pill"><span class="ttt-dot" id="ttt-turn-dot"></span><span id="ttt-status">Your move</span></span>
          <span class="ttt-pill"><span class="ttt-dot x"></span> X wins: <span id="ttt-x-wins">0</span></span>
          <span class="ttt-pill"><span class="ttt-dot o"></span> O wins: <span id="ttt-o-wins">0</span></span>
          <span class="ttt-pill"><span class="ttt-dot"></span> Draws: <span id="ttt-draws">0</span></span>
        </div>
      </div>

      <div class="mindmap" aria-label="Todo mindmap">
        <div class="mm-header">
          <div class="mm-title">
            <h2>Mindmap</h2>
            <p>First todo is the parent node. Every next todo attaches as a child.</p>
          </div>
          <div class="mm-actions">
            <button class="mm-btn" onclick="mmFit()" title="Fit mindmap to available width">Fit</button>
          </div>
        </div>

        <div class="mm-wrap">
          <svg class="mm-svg" id="mm-svg" viewBox="0 0 640 320" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Mindmap of todos">
            <g id="mm-links"></g>
            <g id="mm-nodes"></g>
          </svg>
          <div class="mm-hint" id="mm-hint">Add a todo to start the mindmap.</div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  const API = '';  // same origin

  async function loadTodos() {
    try {
      const res = await fetch(`${API}/todos`);
      const todos = await res.json();
      render(todos);
      renderMindmap(todos);
    } catch (e) {
      showError('Could not load todos: ' + e.message);
    }
  }

  async function addTodo() {
    const input = document.getElementById('new-todo');
    const title = input.value.trim();
    if (!title) return;
    try {
      await fetch(`${API}/todos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title }),
      });
      input.value = '';
      loadTodos();
    } catch (e) { showError(e.message); }
  }

  async function toggleTodo(id, done) {
    try {
      await fetch(`${API}/todos/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ done }),
      });
      loadTodos();
    } catch (e) { showError(e.message); }
  }

  async function deleteTodo(id) {
    try {
      await fetch(`${API}/todos/${id}`, { method: 'DELETE' });
      loadTodos();
    } catch (e) { showError(e.message); }
  }

  function render(todos) {
    const list = document.getElementById('todo-list');
    const stats = document.getElementById('stats');
    const done = todos.filter(t => t.done).length;
    stats.textContent = todos.length
      ? `${todos.length} item${todos.length !== 1 ? 's' : ''} · ${done} completed`
      : '';

    if (!todos.length) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="icon">✅</div>
          <p>Nothing here yet. Add a todo above!</p>
        </div>`;
      return;
    }

    list.innerHTML = todos.map(t => `
      <div class="todo-item ${t.done ? 'done' : ''}">
        <input class="todo-check" type="checkbox" ${t.done ? 'checked' : ''}
               onchange="toggleTodo(${t.id}, this.checked)" />
        <span class="todo-title">${escHtml(t.title)}</span>
        <span class="todo-id">#${t.id}</span>
        <button class="todo-delete" onclick="deleteTodo(${t.id})" title="Delete">×</button>
      </div>`
    ).join('');
  }

  function showError(msg) {
    const el = document.getElementById('error-banner');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
  }

  function escHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  document.getElementById('new-todo').addEventListener('keydown', e => {
    if (e.key === 'Enter') addTodo();
  });

  loadTodos();

  // ─────────────────────────────────────────────────────────────
  // Tic Tac Toe
  // ─────────────────────────────────────────────────────────────

  const TTT_STORAGE_KEY = 'demoSite_ttt_score_v1';
  const ttt = {
    board: Array(9).fill(null),
    turn: 'X',
    over: false,
    winLine: null,
    score: { X: 0, O: 0, D: 0 }
  };

  const TTT_LINES = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];

  function tttLoadScore() {
    try {
      const raw = localStorage.getItem(TTT_STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === 'object') {
        ttt.score.X = Number(parsed.X || 0);
        ttt.score.O = Number(parsed.O || 0);
        ttt.score.D = Number(parsed.D || 0);
      }
    } catch (_) {}
  }

  function tttSaveScore() {
    try {
      localStorage.setItem(TTT_STORAGE_KEY, JSON.stringify(ttt.score));
    } catch (_) {}
  }

  function tttWinner(board) {
    for (const line of TTT_LINES) {
      const [a,b,c] = line;
      if (board[a] && board[a] === board[b] && board[a] === board[c]) {
        return { player: board[a], line };
      }
    }
    if (board.every(v => v)) return { player: 'D', line: null };
    return null;
  }

  function tttSetStatus(text, turn) {
    const status = document.getElementById('ttt-status');
    const dot = document.getElementById('ttt-turn-dot');
    status.textContent = text;

    dot.classList.remove('x', 'o');
    if (turn === 'X') dot.classList.add('x');
    if (turn === 'O') dot.classList.add('o');
  }

  function tttRender() {
    const cells = document.querySelectorAll('.ttt-cell');
    cells.forEach((btn, i) => {
      const v = ttt.board[i];
      btn.textContent = v ? v : '';
      btn.classList.toggle('x', v === 'X');
      btn.classList.toggle('o', v === 'O');
      btn.classList.toggle('win', ttt.winLine ? ttt.winLine.includes(i) : false);
      btn.disabled = ttt.over || !!v;
    });

    document.getElementById('ttt-x-wins').textContent = String(ttt.score.X);
    document.getElementById('ttt-o-wins').textContent = String(ttt.score.O);
    document.getElementById('ttt-draws').textContent = String(ttt.score.D);

    if (!ttt.over) {
      tttSetStatus(`Turn: ${ttt.turn}`, ttt.turn);
    }
  }

  function tttNewGame() {
    ttt.board = Array(9).fill(null);
    ttt.turn = 'X';
    ttt.over = false;
    ttt.winLine = null;
    tttSetStatus('Turn: X', 'X');
    tttRender();
  }

  function tttResetScore() {
    ttt.score = { X: 0, O: 0, D: 0 };
    tttSaveScore();
    tttNewGame();
  }

  function tttPlay(idx) {
    if (ttt.over) return;
    if (ttt.board[idx]) return;

    ttt.board[idx] = ttt.turn;

    const res = tttWinner(ttt.board);
    if (res) {
      ttt.over = true;
      ttt.winLine = res.line;

      if (res.player === 'X') {
        ttt.score.X += 1;
        tttSetStatus('X wins! Press “New game” to play again.', 'X');
      } else if (res.player === 'O') {
        ttt.score.O += 1;
        tttSetStatus('O wins! Press “New game” to play again.', 'O');
      } else {
        ttt.score.D += 1;
        tttSetStatus('Draw. Press “New game” to try again.', null);
      }

      tttSaveScore();
      tttRender();
      return;
    }

    ttt.turn = (ttt.turn === 'X') ? 'O' : 'X';
    tttRender();
  }

  function tttInit() {
    tttLoadScore();

    const board = document.getElementById('ttt-board');
    board.addEventListener('click', (e) => {
      const btn = e.target.closest('.ttt-cell');
      if (!btn) return;
      const idx = Number(btn.getAttribute('data-idx'));
      if (!Number.isFinite(idx)) return;
      tttPlay(idx);
    });

    // Keyboard support: 1-9 map to cells.
    document.addEventListener('keydown', (e) => {
      if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
      const map = { '1': 0, '2': 1, '3': 2, '4': 3, '5': 4, '6': 5, '7': 6, '8': 7, '9': 8 };
      if (map[e.key] !== undefined) tttPlay(map[e.key]);
      if (e.key.toLowerCase() === 'r') tttNewGame();
    });

    tttNewGame();
  }

  tttInit();

  // ─────────────────────────────────────────────────────────────
  // Mindmap (derived from todos)
  // ─────────────────────────────────────────────────────────────

  function mmFit() {
    const svg = document.getElementById('mm-svg');
    // Keep a fixed viewBox for simple rendering; this triggers a re-render sized to current width.
    // (SVG scales automatically, but we also rebuild to update truncation / positions if needed.)
    // If this is called before any render, it will be a no-op.
    try {
      if (window.__lastTodosForMindmap) renderMindmap(window.__lastTodosForMindmap);
    } catch (_) {}
  }

  function renderMindmap(todos) {
    window.__lastTodosForMindmap = todos;

    const svg = document.getElementById('mm-svg');
    const linksG = document.getElementById('mm-links');
    const nodesG = document.getElementById('mm-nodes');
    const hint = document.getElementById('mm-hint');

    // Clear
    linksG.innerHTML = '';
    nodesG.innerHTML = '';

    if (!todos || !todos.length) {
      hint.style.display = 'block';
      return;
    }
    hint.style.display = 'none';

    // Ensure stable ordering: by id ascending.
    const ordered = [...todos].sort((a, b) => (a.id ?? 0) - (b.id ?? 0));

    // Layout: parent in center-left, children vertically to the right.
    // Use actual rendered size for better spacing.
    const rect = svg.getBoundingClientRect();
    const W = Math.max(640, Math.floor(rect.width || 640));
    const H = Math.max(320, Math.floor(rect.height || 320));
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

    const root = ordered[0];
    const children = ordered.slice(1);

    const rootX = Math.round(W * 0.24);
    const rootY = Math.round(H * 0.50);

    const childX = Math.round(W * 0.70);
    const topPad = 34;
    const bottomPad = 34;
    const available = Math.max(1, H - topPad - bottomPad);

    function nodeLabel(todo) {
      const id = todo.id != null ? `#${todo.id} ` : '';
      return `${id}${todo.title || ''}`.trim();
    }

    function truncateForNode(text, maxChars) {
      if (text.length <= maxChars) return text;
      return text.slice(0, Math.max(0, maxChars - 1)).trimEnd() + '…';
    }

    function makeNode(x, y, text, isRoot) {
      // Basic sizing by length; capped.
      const maxTextChars = Math.max(10, Math.min(36, Math.floor((W / 16))));
      const shown = truncateForNode(text, maxTextChars);

      const charW = 7.0;
      const paddingX = 14;
      const minW = 110;
      const maxW = Math.min(360, Math.floor(W * 0.52));
      const boxW = Math.max(minW, Math.min(maxW, Math.floor(shown.length * charW + paddingX * 2)));
      const boxH = 34;
      const rx = 12;

      const x0 = Math.round(x - boxW / 2);
      const y0 = Math.round(y - boxH / 2);

      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');

      const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      r.setAttribute('x', String(x0));
      r.setAttribute('y', String(y0));
      r.setAttribute('width', String(boxW));
      r.setAttribute('height', String(boxH));
      r.setAttribute('rx', String(rx));
      r.setAttribute('ry', String(rx));
      r.setAttribute('class', isRoot ? 'mm-node root' : 'mm-node');

      const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      t.setAttribute('x', String(x));
      t.setAttribute('y', String(y + 4));
      t.setAttribute('text-anchor', 'middle');
      t.setAttribute('class', 'mm-text');
      t.textContent = shown;

      g.appendChild(r);
      g.appendChild(t);
      nodesG.appendChild(g);

      // Connection anchor points
      return {
        left: { x: x0, y },
        right: { x: x0 + boxW, y }
      };
    }

    // Root node
    const rootAnchors = makeNode(rootX, rootY, nodeLabel(root), true);

    // Children nodes + links
    if (children.length) {
      const step = children.length === 1 ? 0 : (available / (children.length - 1));

      children.forEach((c, i) => {
        const y = children.length === 1
          ? rootY
          : Math.round(topPad + i * step);

        const childAnchors = makeNode(childX, y, nodeLabel(c), false);

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const sx = rootAnchors.right.x;
        const sy = rootAnchors.right.y;
        const ex = childAnchors.left.x;
        const ey = childAnchors.left.y;
        const dx = Math.max(40, Math.round((ex - sx) * 0.45));
        const c1x = sx + dx;
        const c1y = sy;
        const c2x = ex - dx;
        const c2y = ey;
        path.setAttribute('d', `M ${sx} ${sy} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${ex} ${ey}`);
        path.setAttribute('class', 'mm-link');
        linksG.appendChild(path);
      });
    }
  }

  // Re-render mindmap if viewport changes size.
  window.addEventListener('resize', () => {
    try {
      if (window.__lastTodosForMindmap) renderMindmap(window.__lastTodosForMindmap);
    } catch (_) {}
  });
</script>

<!--
  AI Dev Panel — remove this block to disable.
  To use a different UI, remove this script and point your UI at http://localhost:8000.
-->
<script
  src="http://localhost:8000/static/dev-panel.js"
  data-agent="http://localhost:8000"
  data-repo="balanco-elias/demo-site"
  data-preview-dir="/tmp/demo-site">
</script>

</body>
</html>
